<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Uploader</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 2rem; }
  .drop { border: 2px dashed #888; padding: 2rem; text-align: center; border-radius: 12px; }
  .drop.drag { background: #f5f5f5; }
  .row { display: grid; gap: .5rem; margin-top: 1rem; }
  label { font-size: .9rem; color: #555; }
  input[type="text"] { padding: .5rem .7rem; border: 1px solid #ccc; border-radius: 8px; width: 100%; }
  button { padding: .6rem 1rem; border: 0; border-radius: 10px; cursor: pointer; }
  .primary { background: #111; color: #fff; }
  img { max-width: 320px; max-height: 240px; display: block; margin-top: 1rem; border-radius: 8px; }
  .muted { color: #777; font-size: .9rem; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  @media (max-width: 640px){ .grid { grid-template-columns: 1fr; } }
  .out { white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; padding: .75rem; border-radius: 8px; }
</style>
</head>
<body>
  <h1>画像アップロード（→ GitHub: nagito-hiroshima/pool）</h1>
  <p class="muted">※ 開発/個人用サンプル。運用時は Cloudflare Access 等で保護してください。</p>

  <div id="drop" class="drop">ここに画像をドラッグ＆ドロップ<br>またはクリックして選択</div>
  <input id="file" type="file" accept="image/*" style="display:none" />

  <div class="grid">
    <div class="row">
      <label>保存ディレクトリ（例: <code>images</code>）</label>
      <input id="dir" type="text" value="/" />
    </div>
    <div class="row">
      <label>任意ファイル名（未指定なら元名使用）</label>
      <input id="filename" type="text" placeholder="optional-filename.png" />
    </div>
  </div>

  <div class="row">
    <label><input id="overwrite" type="checkbox" /> 既存と同パスなら上書きする</label>
  </div>

  <div class="grid">
    <div class="row">
      <label>API Endpoint</label>
      <input id="endpoint" type="text" value="/api/upload" />
    </div>
    <div class="row">
      <label>X-Admin-Token（管理トークン）</label>
      <input id="admin" type="text" placeholder="********" />
    </div>
  </div>

  <img id="preview" alt="" />
  <div class="row">
    <button id="send" class="primary" disabled>アップロード</button>
  </div>
  <div id="out" class="out"></div>

<script>
const $ = (id) => document.getElementById(id);
const drop = $("drop"), file = $("file"), preview = $("preview"), out = $("out");
const sendBtn = $("send");
let pickedFile = null;

/* 画像かどうか判定（MIME があれば優先、なければ拡張子で判定） */
function isImageFile(f) {
  if (!f) return false;
  if (f.type) return f.type.startsWith("image/");
  const name = f.name || "";
  return /\.(jpe?g|png|gif|bmp|webp|svg|heic|heif)$/i.test(name);
}

drop.addEventListener("click", () => file.click());
drop.addEventListener("dragover", (e) => { e.preventDefault(); drop.classList.add("drag"); });
drop.addEventListener("dragleave", () => drop.classList.remove("drag"));
drop.addEventListener("drop", (e) => {
  e.preventDefault(); drop.classList.remove("drag");
  if (e.dataTransfer.files && e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]);
});
file.addEventListener("change", () => {
  if (file.files && file.files[0]) setFile(file.files[0]);
});

function resetSelection() {
  pickedFile = null;
  preview.src = "";
  preview.style.display = "none";
  drop.innerText = "ここに画像をドラッグ＆ドロップ\nまたはクリックして選択";
  sendBtn.disabled = true;
}

function setFile(f) {
  if (!isImageFile(f)) {
    alert("画像ファイルのみ選択できます（jpg, png, gif, webp, svg 等）");
    resetSelection();
    return;
  }

  pickedFile = f;
  const url = URL.createObjectURL(f);
  preview.src = url;
  preview.style.display = "block";
  drop.innerText = `${f.name} (${Math.round(f.size/1024)} KB)`;
  sendBtn.disabled = false;
}

$("send").addEventListener("click", async () => {
  if (!pickedFile) { alert("ファイルを選んでください"); return; }
  if (!isImageFile(pickedFile)) { alert("画像ファイルのみアップロード可能です"); return; }
  out.textContent = "アップロード中…";

  const fd = new FormData();
  fd.append("file", pickedFile);
  fd.append("dir", $("dir").value || "images");
  if ($("filename").value) fd.append("filename", $("filename").value);
  fd.append("overwrite", $("overwrite").checked ? "true" : "false");

  try {
    const res = await fetch($("endpoint").value || "/api/upload", {
      method: "POST",
      headers: {
        "X-Admin-Token": $("admin").value || ""
      },
      body: fd
    });

    const text = await res.text();
    try {
      const json = JSON.parse(text);
      out.textContent = JSON.stringify(json, null, 2);
      if (json.rawUrl) {
        out.innerHTML += `\n\n<a href="${json.rawUrl}" target="_blank" rel="noopener">rawUrlを開く</a>`;
      }
    } catch {
      out.textContent = text;
    }
  } catch (err) {
    out.textContent = "アップロードに失敗しました: " + (err && err.message ? err.message : String(err));
  }
});
</script>
</body>
</html>
