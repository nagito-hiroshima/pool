<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ç´ æã‚µã‚¤ãƒˆ</title>
  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; padding: 20px; }
    h1 { margin: 0 0 8px; }
    .muted { color:#666; font-size:12px; }
    /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
    .upload-btn { text-decoration: none; display: inline-block; padding: 8px 12px; border-radius: 10px; font-weight: 600; }
    .upload-btn.primary { background:#111; color:#fff; border: 1px solid #111; }

    /* grid */
    ul { list-style: none; padding: 0; display: flex; flex-wrap: wrap; gap: var(--gap); }
    li { width: 140px; text-align: center; }
    a.card { color: inherit; text-decoration: none; display: block; }
    .thumb { max-width:120px; height:auto; display:block; margin:0 auto 6px; border:1px solid #ddd; border-radius:6px; background:
      repeating-linear-gradient(45deg,#f6f6f6 0 10px,#fff 10px 20px); }
    .name { font-size: 13px; word-break: break-word; }
    .folder-name { font-size: 18px; font-weight: bold; margin-top: 24px; margin-bottom: 12px; }

    hr { margin: 20px 0; border: none; border-top: 1px solid #eee; }

    /* modal */
    .modal {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.6); z-index: 9999; padding: 20px;
    }
    .modal.open { display: flex; }
    .modal-box {
      background: #fff; width: min(1100px, 96vw); max-height: 92vh;
      border-radius: 14px; overflow: hidden; display: grid;
      grid-template-columns: 1.2fr 1fr;
    }
    @media (max-width: 820px) {
      .modal-box { grid-template-columns: 1fr; }
    }

    /* å·¦ãƒšã‚¤ãƒ³ï¼ˆç”»åƒï¼‰*/
    .modal-media {
      position: relative;
      display:flex; align-items:center; justify-content:center;
      min-height: 320px;
      overflow: auto;              /* â† ç­‰å€æ™‚ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ */
      background: #111;
    }
    /* èƒŒæ™¯ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆcheckerï¼‰ */
    .bg-checker {
      background:
        linear-gradient(45deg, #bbb 25%, transparent 25%) 0 0/20px 20px,
        linear-gradient(-45deg, #bbb 25%, transparent 25%) 0 0/20px 20px,
        linear-gradient(45deg, transparent 75%, #bbb 75%) 0 0/20px 20px,
        linear-gradient(-45deg, transparent 75%, #bbb 75%) 0 0/20px 20px,
        #eee;
    }
    .bg-light { background: #f5f5f5; }
    .bg-dark  { background: #111; }

    .modal-media img {
      display:block;
      background: transparent;
      /* ä¸‹ã®ã‚¯ãƒ©ã‚¹åˆ‡æ›¿ã§æŒ¯ã‚‹èˆã„ã‚’å¤‰æ›´ */
    }
    .fit img {
      max-width: 100%;
      max-height: 86vh;      /* ãƒ˜ãƒƒãƒ€æ§ãˆã‚ã« */
      object-fit: contain;
    }
    .actual img {
      max-width: none;       /* ç­‰å€è¡¨ç¤ºï¼ˆæ‹¡å¤§ç”»åƒã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
      max-height: none;
    }

    .nav {
      position: absolute; inset: 0; display: flex; justify-content: space-between; align-items: center; pointer-events: none;
    }
    .nav button {
      pointer-events: auto; border:none; background: rgba(255,255,255,.85);
      width: 44px; height: 44px; border-radius:999px; cursor:pointer; font-size:20px;
    }

    .modal-info { padding: 16px 16px 12px; overflow: auto; }
    .modal-title { margin: 0 0 6px; font-size: 18px; }
    .meta { font-size: 12px; color:#555; margin: 6px 0 12px; }
    .desc { font-size: 14px; margin: 10px 0 16px; white-space: pre-wrap; }
    .row { display: flex; gap: 8px; align-items: center; margin: 8px 0; flex-wrap: wrap; }
    .urlbox { flex: 1; min-width: 220px; font-size: 12px; padding: 8px; border:1px solid #ddd; border-radius: 8px; background:#fafafa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .btn {
      appearance: none; border:1px solid #ddd; background:#fff; border-radius: 10px;
      padding: 8px 12px; cursor: pointer; font-size: 13px;
      transition: box-shadow .15s, transform .02s;
    }
    .btn:hover { box-shadow: 0 3px 10px rgba(0,0,0,.1); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background:#111; color:#fff; border-color:#111; }
    .seg { display:inline-flex; border:1px solid #ddd; border-radius:10px; overflow:hidden; }
    .seg button { border:none; padding:8px 10px; background:#fff; cursor:pointer; font-size:13px; }
    .seg button.active { background:#111; color:#fff; }

    .modal-head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom: 8px; }
    .iconbtn { border:none; background:transparent; cursor:pointer; font-size:22px; line-height:1; padding: 4px 8px; color:#999; }
    .iconbtn:hover { color:#333; }

    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(0,0,0,.85); color:#fff; font-size:13px; padding: 8px 12px; border-radius: 999px;
      opacity: 0; pointer-events: none; transition: opacity .25s;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
    <h1>ğŸ“‚ ç´ æä¸€è¦§</h1>
    <div>
      <a href="./upload" class="upload-btn primary" target="_blank" rel="noopener">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
    </div>
  </div>
  <div id="app"><p class="muted">èª­ã¿è¾¼ã¿ä¸­...</p></div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-box">
      <div id="media" class="modal-media fit bg-checker">
        <img id="modalImg" alt="">
        <div class="nav">
          <button id="prevBtn" title="å‰ã¸">â€¹</button>
          <button id="nextBtn" title="æ¬¡ã¸">â€º</button>
        </div>
      </div>
      <div class="modal-info">
        <div class="modal-head">
          <h2 id="modalTitle" class="modal-title"></h2>
          <button id="closeBtn" class="iconbtn" aria-label="é–‰ã˜ã‚‹">âœ•</button>
        </div>

        <div id="modalDesc" class="desc"></div>
        <div id="modalMeta" class="meta"></div>

        <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
        <div class="row">
          <div class="seg" id="viewSeg">
            <button data-mode="fit" class="active" title="ç”»é¢ã«åˆã‚ã›ã¦è¡¨ç¤º">ãƒ•ã‚£ãƒƒãƒˆ</button>
            <button data-mode="actual" title="ç­‰å€è¡¨ç¤ºï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ï¼‰">ç­‰å€</button>
          </div>

          <!-- èƒŒæ™¯åˆ‡æ›¿ -->
          <div class="seg" id="bgSeg">
            <button data-bg="checker" class="active" title="ãƒã‚§ãƒƒã‚¯æŸ„">ãƒã‚§ãƒƒã‚¯</button>
            <button data-bg="light" title="æ˜ã‚‹ã„">ç™½</button>
            <button data-bg="dark" title="æš—ã„">é»’</button>
          </div>
          <label class="btn" style="display:inline-flex;align-items:center;gap:6px;">
            <span>è‰²</span>
            <input id="bgPicker" type="color" value="#eeeeee" style="border:none;background:transparent;width:24px;height:24px;padding:0;cursor:pointer;">
          </label>
          <button id="bgReset" class="btn">èƒŒæ™¯ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="row">
          <div id="urlText" class="urlbox"></div>
          <button id="copyBtn" class="btn">URLã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>

        <div class="row">
          <button id="openBtn" class="btn primary">æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã</button>
          <button id="copyMdBtn" class="btn">Markdown ã‚’ã‚³ãƒ”ãƒ¼</button>
          <button id="copyHtmlBtn" class="btn">HTML ã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <script type="module">
    const $app = document.getElementById('app');
    const modal = document.getElementById('modal');
    const media = document.getElementById('media');
    const imgEl = document.getElementById('modalImg');
    const titleEl = document.getElementById('modalTitle');
    const descEl = document.getElementById('modalDesc');
    const metaEl = document.getElementById('modalMeta');
    const urlText = document.getElementById('urlText');
    const copyBtn = document.getElementById('copyBtn');
    const copyMdBtn = document.getElementById('copyMdBtn');
    const copyHtmlBtn = document.getElementById('copyHtmlBtn');
    const openBtn = document.getElementById('openBtn');
    const closeBtn = document.getElementById('closeBtn');
    const toast = document.getElementById('toast');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const viewSeg = document.getElementById('viewSeg');
    const bgSeg = document.getElementById('bgSeg');
    const bgPicker = document.getElementById('bgPicker');
    const bgReset = document.getElementById('bgReset');

    const toRel = (p) => p.startsWith('/') ? '.' + p : p;
    const toAbs = (p) => new URL(toRel(p), location.href).href;

    let catalog = { files: [] };
    let flat = [];
    let current = -1;

    const showToast = (msg) => {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1200);
    };

    // èƒŒæ™¯ã‚¯ãƒ©ã‚¹é©ç”¨
    const setBg = (kind, customColor=null) => {
      media.classList.remove('bg-checker','bg-light','bg-dark');
      media.style.background = '';
      if (kind === 'checker') media.classList.add('bg-checker');
      else if (kind === 'light') media.classList.add('bg-light');
      else if (kind === 'dark') media.classList.add('bg-dark');
      else if (kind === 'custom' && customColor) {
        media.style.background = customColor;
      }
      // seg ã®è¦‹ãŸç›®æ›´æ–°
      for (const b of bgSeg.querySelectorAll('button')) b.classList.toggle('active', b.dataset.bg === kind);
    };

    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚£ãƒƒãƒˆï¼ç­‰å€ï¼‰
    const setViewMode = (mode) => {
      media.classList.remove('fit','actual');
      media.classList.add(mode);
      for (const b of viewSeg.querySelectorAll('button')) b.classList.toggle('active', b.dataset.mode === mode);
      // ç­‰å€ã«ã—ãŸç›´å¾Œã¯åŸç‚¹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹
      if (mode === 'actual') media.scrollTo({top:0,left:0,behavior:'instant'});
    };

    const openModal = (idx) => {
      current = idx;
      const f = flat[idx];
      if (!f) return;

      imgEl.src = toRel(f.path);
      imgEl.alt = f.name;
      titleEl.textContent = f.name;
      descEl.textContent = f.description || '';
      metaEl.textContent = `dir: ${f.dir}  /  type: ${f.type}  /  uploaded: ${new Date(f.uploaded_at).toLocaleString()}`;
      urlText.textContent = toAbs(f.path);

      openBtn.onclick = () => window.open(toRel(f.path), '_blank', 'noopener');
      copyBtn.onclick = async () => { await navigator.clipboard.writeText(toAbs(f.path)); showToast('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); };
      copyMdBtn.onclick = async () => { await navigator.clipboard.writeText(`![${f.name}](${toAbs(f.path)})`); showToast('Markdownã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); };
      copyHtmlBtn.onclick = async () => { await navigator.clipboard.writeText(`<img src="${toAbs(f.path)}" alt="${f.name}">`); showToast('HTMLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); };

      // åˆæœŸçŠ¶æ…‹ï¼šãƒ•ã‚£ãƒƒãƒˆï¼‹ãƒã‚§ãƒƒã‚¯èƒŒæ™¯
      setViewMode('fit');
      setBg('checker');

      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    };

    const closeModal = () => {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      imgEl.src = '';
      current = -1;
    };

    const openPrev = () => { if (flat.length) openModal((current - 1 + flat.length) % flat.length); };
    const openNext = () => { if (flat.length) openModal((current + 1) % flat.length); };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => {
      if (!modal.classList.contains('open')) return;
      if (e.key === 'Escape') closeModal();
      if (e.key === 'ArrowLeft') openPrev();
      if (e.key === 'ArrowRight') openNext();
    });
    prevBtn.addEventListener('click', openPrev);
    nextBtn.addEventListener('click', openNext);

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ“ä½œ
    viewSeg.addEventListener('click', (e) => {
      const mode = e.target?.dataset?.mode;
      if (mode) setViewMode(mode);
    });
    bgSeg.addEventListener('click', (e) => {
      const bg = e.target?.dataset?.bg;
      if (bg) setBg(bg);
    });
    bgPicker.addEventListener('input', () => setBg('custom', bgPicker.value));
    bgReset.addEventListener('click', () => { bgPicker.value = '#eeeeee'; setBg('checker'); });

    const render = (data) => {
      const byDir = new Map();
      for (const f of data.files || []) {
        if (!byDir.has(f.dir)) byDir.set(f.dir, []);
        byDir.get(f.dir).push(f);
      }
      for (const arr of byDir.values()) arr.sort((a,b)=>a.name.localeCompare(b.name,'ja'));
      const dirs = [...byDir.keys()].sort((a,b)=>a.localeCompare(b,'ja'));

      flat = dirs.flatMap(d => byDir.get(d));

      const frag = document.createDocumentFragment();

      dirs.forEach(dir => {
        const files = byDir.get(dir);
        const h = document.createElement('div');
        h.className = 'folder-name';
        h.textContent = dir;
        frag.appendChild(h);

        const ul = document.createElement('ul');
        files.forEach((f) => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = toRel(f.path);
          a.className = 'card';
          a.addEventListener('click', (ev) => { ev.preventDefault(); openModal(flat.indexOf(f)); });

          const img = document.createElement('img');
          img.src = toRel(f.path);
          img.alt = f.name;
          img.loading = 'lazy';
          img.className = 'thumb';

          const nm = document.createElement('div');
          nm.className = 'name';
          nm.textContent = f.name;

          a.appendChild(img);
          a.appendChild(nm);
          li.appendChild(a);
          ul.appendChild(li);
        });
        frag.appendChild(ul);
        frag.appendChild(document.createElement('hr'));
      });

      $app.innerHTML = '';
      $app.appendChild(frag);

      const meta = document.createElement('p');
      meta.className = 'muted';
      meta.textContent = `version ${data.version} / generated_at ${data.generated_at}\n by moenaigomi.com`;
      $app.appendChild(meta);
    };

    // èµ·å‹•
    try {
      const res = await fetch('./content.json', { cache: 'no-cache' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      catalog = await res.json();
      render(catalog);
    } catch (e) {
      $app.innerHTML = `<p style="color:#c00">JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${String(e)}</p>`;
    }
  </script>
</body>
</html>
